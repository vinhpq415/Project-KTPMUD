@model IEnumerable<BTL.Models.ParkingTicket>
@using BTL.Enums

@{
    ViewData["Title"] = "Quản lý bãi xe";
}

<h2>@ViewData["Title"]</h2>
<hr />

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        <strong>Lỗi:</strong> @TempData["Error"]
    </div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @Html.Raw(TempData["SuccessMessage"])
    </div>
}

<div class="card mb-4">
    <div class="card-header">
        Ghi nhận xe vào bãi
    </div>
    <div class="card-body">
        <form action="/Parking/CheckIn" method="post" class="row g-3">

            <div class="col-md-4">
                <label for="vehicleType" class="form-label">Loại phương tiện</label>
                <select id="vehicleType" name="vehicleType" class="form-select">
                    <option value="0">Xe đạp</option>
                    <option value="1">Xe máy</option>
                    <option value="2">Xe máy điện</option>
                    <option value="3">Xe ô tô</option>
                </select>
            </div>

            <div class="col-md-4" id="licensePlateGroup">
                <label for="licensePlate" class="form-label">Biển số xe</label>
                <input type="text" id="licensePlate" name="licensePlate" class="form-control" />
            </div>

            <div class="col-md-4 align-self-end">
                <button type="submit" class="btn btn-primary w-100">Xác nhận vào</button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Danh sách xe đang gửi
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Loại xe</th>
                    <th>Biển số / Số vé</th>
                    <th>Thời gian vào</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                @switch (item.VehicleType)
                                {
                                    case VehicleType.Bicycle:
                                        <span>Xe đạp</span>
                                        break;
                                    case VehicleType.Motorbike:
                                        <span>Xe máy</span>
                                        break;
                                    case VehicleType.Ebike:
                                        <span class="text-primary">Xe máy điện</span>
                                        break;
                                    case VehicleType.Car:
                                        <span class="text-danger fw-bold">Ô tô</span>
                                        break;
                                }
                            </td>

                            <td>
                                @if (item.VehicleType == VehicleType.Bicycle)
                                {
                                    <span class="badge bg-secondary">Vé số: @item.TicketNumber</span>
                                }
                                else
                                {
                                    <span class="badge bg-info text-dark">@item.LicensePlate</span>
                                }
                            </td>

                            <td>@item.TimeIn.ToString("dd/MM/yyyy HH:mm:ss")</td>

                            <td>
                                <form action="/Parking/CheckOut" method="post" style="display:inline;">

                                    <input type="hidden" name="ticketId" value="@item.Id" />

                                    <button type="submit" class="btn btn-danger btn-sm"
                                            onclick="return confirm('Bạn có chắc chắn muốn cho xe này ra?');">
                                        Cho ra
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center">Chưa có xe nào trong bãi.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // Script ẩn hiện biển số khi chọn xe đạp
        var typeSelect = document.getElementById('vehicleType');
        var plateGroup = document.getElementById('licensePlateGroup');
        var plateInput = document.getElementById('licensePlate');

        function togglePlateInput() {
            if (typeSelect.value == '0') { // 0 là Xe đạp
                plateGroup.style.display = 'none';
                plateInput.value = '';
            } else {
                plateGroup.style.display = 'block';
            }
        }

        typeSelect.addEventListener('change', togglePlateInput);
        togglePlateInput(); // Chạy 1 lần lúc mới tải trang
    </script>
}